<section class="auth-wrapper">
  <mat-card class="auth-card">
    <!-- Header -->
    <header class="mb-6 flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-semibold">{{ 'profile.title' | translate }}</h2>
        <p class="text-sm text-gray-500">{{ 'profile.subtitle' | translate }}</p>
      </div>

      <a routerLink="/settings" mat-stroked-button class="btn-ghost">
        <mat-icon class="mr-2">settings</mat-icon>
        {{ 'profile.settings' | translate }}
      </a>
    </header>

    <mat-card-content>
      <ng-container *ngIf="user() as u; else loadingTpl">
        <div class="grid gap-6 xl:gap-8 grid-cols-1 md:grid-cols-[320px_1fr]">
          <!-- Colonne gauche -->
          <aside class="panel">
            <h3 class="panel-title">{{ 'profile.photo.title' | translate }}</h3>

            <div class="flex items-center gap-4">
              <div class="avatar-wrap">
                <img *ngIf="photoPreviewUrl(); else currentPhoto"
                     [src]="photoPreviewUrl()!" alt="preview" class="avatar-img"/>
                <ng-template #currentPhoto>
                  <img *ngIf="resolvePhotoUrl(u.profilePhoto); else placeholder"
                       [src]="resolvePhotoUrl(u.profilePhoto)!" alt="profile" class="avatar-img"/>
                  <ng-template #placeholder>
                    <div class="avatar-ph">
                      <mat-icon>person</mat-icon>
                    </div>
                  </ng-template>
                </ng-template>
              </div>

              <div class="flex-1 min-w-0">
                <input type="file" accept="image/*" (change)="onPhotoSelected($event)" class="file-input"/>
                <button mat-stroked-button color="primary" class="mt-2 w-full" (click)="uploadPhoto()">
                  <mat-icon class="mr-2">upload</mat-icon>
                  {{ 'profile.photo.update' | translate }}
                </button>
              </div>
            </div>

            <section *ngIf="isCompany()" class="mt-6">
              <h3 class="panel-title">{{ 'profile.company.title' | translate }}</h3>

              <div class="space-y-3">
                <div class="label-row">
                  <span class="label">{{ 'profile.company.number' | translate }}</span>
                  <span class="value">{{ u.companyNumber || '—' }}</span>
                </div>

                <div class="label-row">
                  <span class="label">{{ 'profile.company.status' | translate }}</span>
                  <span class="chip"
                        [ngClass]="{
                          'chip-pending' : u.verificationStatus === 'PENDING',
                          'chip-rejected': u.verificationStatus === 'REJECTED',
                          'chip-verified': u.verificationStatus === 'APPROVED'
                        }">
                    {{ u.verificationStatus }}
                  </span>
                </div>

                <div class="mt-4">
                  <label class="block text-sm font-medium mb-1">
                    {{ 'profile.company.docLabel' | translate }}
                  </label>
                  <input type="file" accept="application/pdf" (change)="onVerificationSelected($event)" class="file-input"/>

                  <p class="hint mt-2">{{ 'profile.company.docHint1' | translate }}</p>
                  <p class="hint">{{ 'profile.company.docHint2' | translate }}</p>

                  <p class="text-sm mt-1" *ngIf="verificationDocumentName()">
                    {{ 'profile.company.selected' | translate }}:
                    <strong>{{ verificationDocumentName() }}</strong>
                  </p>
                </div>
              </div>
            </section>
          </aside>

          <!-- Colonne droite -->
          <section class="panel">
            <h3 class="panel-title">{{ 'profile.title' | translate }}</h3>

            <form class="space-y-5" (ngSubmit)="update()" enctype="multipart/form-data">
              <div class="form-grid">
                <mat-form-field appearance="fill">
                  <mat-label>{{ 'profile.form.firstName' | translate }}</mat-label>
                  <input matInput [(ngModel)]="u.firstName" name="firstName"/>
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>{{ 'profile.form.lastName' | translate }}</mat-label>
                  <input matInput [(ngModel)]="u.lastName" name="lastName"/>
                </mat-form-field>
              </div>

              <div class="form-grid">
                <mat-form-field appearance="fill" class="md:col-span-2">
                  <mat-label>{{ 'profile.form.email' | translate }}</mat-label>
                  <input matInput [value]="u.email" disabled/>
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>{{ 'profile.form.language' | translate }}</mat-label>
                  <mat-select [(ngModel)]="u.preferredLanguage" name="preferredLanguage">
                    <mat-option value="fr">Français</mat-option>
                    <mat-option value="en">English</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <!-- ✅ Compte bancaire (optionnel) -->
              <mat-form-field appearance="fill" class="w-full">
                <mat-label>{{ 'profile.form.bankAccount' | translate }}</mat-label>
                <input
                  matInput
                  [(ngModel)]="u.bankAccount"
                  name="bankAccount"
                  autocomplete="off"
                  placeholder="BE68 5390 0754 7034"
                  (blur)="normalizeIban()"
                />
                <mat-hint>{{ 'profile.form.bankAccountHint' | translate }}</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="fill" class="w-full">
                <mat-label>{{ 'profile.form.bio' | translate }}</mat-label>
                <textarea matInput rows="5" [(ngModel)]="u.bio" name="bio"></textarea>
              </mat-form-field>

              <!-- compat backend -->
              <input type="hidden" [value]="u.profilePhoto || ''" name="profilePhoto"/>

              <div class="flex justify-end">
                <button mat-raised-button color="primary" type="submit" class="btn-primary">
                  <mat-icon class="mr-2">save</mat-icon>
                  {{ 'profile.actions.save' | translate }}
                </button>
              </div>
            </form>

            <!-- ====== Bloc Sécurité : changement de mot de passe ====== -->
            <section class="panel mt-6">
              <h3 class="panel-title flex items-center gap-2">
                <mat-icon>lock</mat-icon>
                {{ 'profile.security.title' | translate }}
              </h3>

              <form class="space-y-4" (ngSubmit)="changePassword()">
                <mat-form-field appearance="fill" class="w-full">
                  <mat-label>{{ 'profile.security.current' | translate }}</mat-label>
                  <input
                    matInput
                    [type]="showPwd ? 'text' : 'password'"
                    [(ngModel)]="pwd().current"
                    name="currentPassword"
                    autocomplete="current-password"
                    required
                  />
                  <button mat-icon-button matSuffix type="button" (click)="toggleShowPwd()" [attr.aria-label]="'toggle'">
                    <mat-icon>{{ showPwd ? 'visibility_off' : 'visibility' }}</mat-icon>
                  </button>
                </mat-form-field>

                <mat-form-field appearance="fill" class="w-full">
                  <mat-label>{{ 'profile.security.new' | translate }}</mat-label>
                  <input
                    matInput
                    [type]="showPwd ? 'text' : 'password'"
                    [(ngModel)]="pwd().next"
                    name="newPassword"
                    autocomplete="new-password"
                    required
                  />
                  <mat-hint>{{ 'profile.security.hint' | translate }}</mat-hint>
                </mat-form-field>

                <mat-form-field appearance="fill" class="w-full">
                  <mat-label>{{ 'profile.security.confirm' | translate }}</mat-label>
                  <input
                    matInput
                    [type]="showPwd ? 'text' : 'password'"
                    [(ngModel)]="pwd().confirm"
                    name="confirmPassword"
                    autocomplete="new-password"
                    required
                  />
                </mat-form-field>

                <div class="flex justify-end">
                  <button mat-raised-button color="primary" type="submit" class="btn-primary">
                    <mat-icon class="mr-2">save</mat-icon>
                    {{ 'profile.security.action' | translate }}
                  </button>
                </div>
              </form>
            </section>
          </section>
        </div>
      </ng-container>

      <ng-template #loadingTpl>
        <div class="flex justify-center py-10">
          <mat-progress-spinner mode="indeterminate" diameter="36"></mat-progress-spinner>
        </div>
      </ng-template>
    </mat-card-content>
  </mat-card>

  <!-- Danger zone -->
  <div class="mt-8 p-4 border border-red-300 rounded-xl bg-red-50">
    <h3 class="text-lg font-semibold text-red-700 mb-2 flex items-center gap-2">
      <mat-icon color="warn">warning</mat-icon>
      {{ 'profile.delete.warningTitle' | translate }}
    </h3>

    <p class="text-sm text-red-600 mb-4">
      {{ 'profile.delete.warningText' | translate }}
    </p>

    <button mat-stroked-button color="warn"
            (click)="delete()"
            class="w-full md:w-auto">
      <mat-icon class="mr-2">delete</mat-icon>
      {{ 'profile.actions.delete' | translate }}
    </button>
  </div>

  <mat-divider class="my-8"></mat-divider>

  <!-- Mes rapports -->
  <section class="auth-card p-5">
    <h3 class="section-title mb-4">{{ 'profile.reports.title' | translate }}</h3>
    <ng-container *ngIf="isCompany(); else researcherReports">
      <app-company-received></app-company-received>
    </ng-container>
    <ng-template #researcherReports>
      <app-my-reports></app-my-reports>
    </ng-template>
  </section>
</section>
