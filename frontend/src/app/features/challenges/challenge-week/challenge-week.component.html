<div class="container mx-auto max-w-3xl px-4 py-6">

  <!-- Loading -->
  <div class="flex justify-center py-10" *ngIf="loading()">
    <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
  </div>

  <!-- Erreur / pas de défis -->
  <div class="text-center text-gray-500" *ngIf="!loading() && (!challenges().length || error())">
    <mat-icon>hourglass_empty</mat-icon>
    <p class="mt-2">{{ error() || "Aucun défi actif actuellement." }}</p>
  </div>

  <!-- Carousel -->
  <ng-container *ngIf="!loading() && challenges().length">
    <div class="flex items-center justify-between mb-3">
      <button mat-icon-button (click)="prev()" aria-label="Précédent">
        <mat-icon>chevron_left</mat-icon>
      </button>

      <div class="text-sm text-gray-600">
        Défi {{ idx() + 1 }} / {{ challenges().length }}
      </div>

      <button mat-icon-button (click)="next()" aria-label="Suivant">
        <mat-icon>chevron_right</mat-icon>
      </button>
    </div>

    <mat-card *ngIf="current() as c" class="rounded-2xl shadow-md">
      <mat-card-header>
        <div mat-card-avatar class="bg-gray-200 rounded-full"></div>
        <mat-card-title class="text-lg font-semibold">{{ c.title }}</mat-card-title>
        <mat-card-subtitle class="text-xs">
          <span class="mr-2">{{ c.startDate | date:'mediumDate' }} → {{ c.endDate | date:'mediumDate' }}</span>
          <mat-chip-set class="ml-2">
            <mat-chip [ngClass]="{
              'bg-green-100 text-green-800': (c.startDate | challengeStatus:c.endDate) === 'En cours',
              'bg-blue-100 text-blue-800': (c.startDate | challengeStatus:c.endDate) === 'A venir',
              'bg-gray-200 text-gray-700': (c.startDate | challengeStatus:c.endDate) === 'Terminé'
            }">
              {{ c.startDate | challengeStatus:c.endDate }}
            </mat-chip>
            <mat-chip *ngIf="c.endDate" class="ml-2">
              ⏳ {{ c.endDate | timeLeft }}
            </mat-chip>
          </mat-chip-set>
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content class="space-y-3">
        <p class="whitespace-pre-line">{{ c.description }}</p>

        <a *ngIf="c.linkToResource"
           [href]="c.linkToResource"
           target="_blank"
           rel="noopener"
           class="inline-flex items-center underline">
          <mat-icon class="mr-1" aria-hidden="true">open_in_new</mat-icon>
          Accéder à la ressource du défi
        </a>

        <div class="pt-2">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Entre ton code</mat-label>
            <input matInput
                   [ngModel]="flag()"
                   (ngModelChange)="flag.set($event)"
                   [disabled]="submitting() || (c.startDate | challengeStatus:c.endDate) !== 'En cours'">
          </mat-form-field>

          <button mat-raised-button color="primary"
                  (click)="submit()"
                  [disabled]="submitting() || !flag() || (c.startDate | challengeStatus:c.endDate) !== 'En cours'">
            <mat-icon class="mr-1" aria-hidden="true">flag</mat-icon>
            Soumettre
          </button>
        </div>

        <p class="mt-2"
           *ngIf="message()"
           [ngClass]="{
             'text-green-600': status() === 'success',
             'text-red-500': status() === 'error'
           }">
          {{ message() }}
        </p>
      </mat-card-content>
    </mat-card>

    <!-- petits indicateurs -->
    <div class="flex justify-center gap-2 mt-4">
      <button *ngFor="let _ of challenges(); let i = index"
              class="w-2.5 h-2.5 rounded-full"
              [ngClass]="{ 'bg-gray-400': idx()!==i, 'bg-gray-900': idx()===i }"
              (click)="idx.set(i)">
      </button>
    </div>
  </ng-container>
</div>
